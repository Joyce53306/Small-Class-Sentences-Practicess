<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Speaking Practice</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Eng Practice">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#00BCD4">

    <style>
        /* --- CSS æ¨£å¼è¨­è¨ˆ (è®“ä»‹é¢åœ¨æ‰‹æ©Ÿå’Œé›»è…¦éƒ½å¥½çœ‹) --- */
        :root {
            --primary-color: #00BCD4;
            --secondary-color: #FF5722;
            --bg-color: #E0F7FA;
            --card-bg: #ffffff;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            /* é˜²æ­¢æ‰‹æ©Ÿä¸Šé›™æ“Šç¸®æ”¾ */
            touch-action: manipulation; 
        }

        .container {
            background-color: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 25px;
            width: 100%;
            max-width: 500px; /* åœ¨å¤§è¢å¹•ä¸Šé™åˆ¶æœ€å¤§å¯¬åº¦ */
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        /* èª²ç¨‹é¸æ“‡é¸å–® */
        select {
            width: 100%;
            padding: 12px;
            margin-bottom: 25px;
            border-radius: 10px;
            border: 2px solid var(--primary-color);
            font-size: 1rem;
            background: white;
        }

        /* å¥å­é¡¯ç¤ºå¡ç‰‡ */
        .sentence-card {
            background-color: #f9f9f9;
            border-radius: 15px;
            padding: 30px 20px;
            margin-bottom: 30px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }

        .sentence-text {
            font-size: 1.6rem;
            color: #333;
            font-weight: bold;
            line-height: 1.4;
        }

        /* æŒ‰éˆ•å€åŸŸ */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: 50%; /* åœ“å½¢æŒ‰éˆ• */
            width: 70px;
            height: 70px;
            font-size: 1.8rem;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn:active {
            transform: scale(0.95);
        }

        #speakBtn { background-color: var(--primary-color); }
        #recordBtn { background-color: var(--secondary-color); }
        #recordBtn.recording { 
            background-color: #d32f2f; 
            animation: pulse 1.5s infinite;
        }
        #playbackBtn { background-color: #4CAF50; }
        .disabled { opacity: 0.4; pointer-events: none; }

        /* å°èˆªæŒ‰éˆ• (ä¸Šä¸€å¥/ä¸‹ä¸€å¥) */
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .nav-btn {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
        }
        .nav-btn:hover { background-color: #e0f7fa; }

        .status-text {
            margin-top: 15px;
            color: #666;
            font-size: 0.9rem;
            height: 1.2em;
        }

        /* éŒ„éŸ³ä¸­å‹•ç•« */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 87, 34, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0); }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 id="lessonTitle">English Practice</h1>

    <select id="lessonSelect">
        </select>

    <div class="sentence-card">
        <div class="sentence-text" id="currentSentence">Loading...</div>
    </div>

    <div class="controls">
        <div>
            <button id="speakBtn" class="btn" title="è€å¸«å”¸">ğŸ”Š</button>
            <div style="margin-top: 5px; font-size: 0.8rem; color: #666;">è½è€å¸«å”¸</div>
        </div>
        <div>
            <button id="recordBtn" class="btn" title="é–‹å§‹/åœæ­¢éŒ„éŸ³">ğŸ¤</button>
            <div style="margin-top: 5px; font-size: 0.8rem; color: #666;" id="recLabel">éŒ„éŸ³</div>
        </div>
        <div>
            <button id="playbackBtn" class="btn disabled" title="æ’­æ”¾æˆ‘çš„éŒ„éŸ³">â–¶ï¸</button>
            <div style="margin-top: 5px; font-size: 0.8rem; color: #666;">æ’­æˆ‘çš„è²éŸ³</div>
        </div>
    </div>

    <div class="status-text" id="status"></div>

    <div class="navigation">
        <button id="prevBtn" class="nav-btn">â† ä¸Šä¸€å¥</button>
        <span style="align-self: center; color: #999;" id="counter">1 / 10</span>
        <button id="nextBtn" class="nav-btn">ä¸‹ä¸€å¥ â†’</button>
    </div>
</div>


<script>
    /* --- JavaScript é‚è¼¯æ§åˆ¶ --- */

    // 1. è³‡æ–™æº–å‚™ï¼šå°‡æ‚¨æä¾›çš„æ‰€æœ‰èª²ç¨‹å…§å®¹æ•´ç†æˆè³‡æ–™çµæ§‹
    const lessonData = [
        {
            title: "Lesson One: I Can Move",
            sentences: [
                "I can move.", "I can swing.", "I can walk.", "I can swim.",
                "I can run.", "I can play.", "I can jump.", "I can climb.",
                "I can dance.", "I can sleep."
            ]
        },
        {
            title: "Lesson Two: What Am I?",
            sentences: [
                "Is it a snake?", "Is it a fox?", "Is it a fish?", "Is it a bear?",
                "Is it a rabbit?", "Is it a spider?", "Is it a cat?", "Is it a mouse?",
                "Yes, it is.", "No, it is not."
            ]
        },
        {
            title: "Lesson Three: Look at Me!",
            sentences: [
                "Look at me. I am a monkey.", "Look at me. I am a bird.",
                "Look at me. I am a pig.", "Look at me. I am a turtle.",
                "Look at me. I am a dog.", "Look at me. I am a frog.",
                "Look at me. I am a lion.", "Look at me. I am a butterfly.",
                "Look at me. I am an alligator.", "Look at me. I am an elephant."
            ]
        },
        {
            title: "Lesson Four: Shake, Shake",
            sentences: [
                "Hand, hand, shake, shake.", "Head, head, shake, shake.",
                "Shoulder, shoulder, shake, shake.", "Tummy, tummy, shake, shake.",
                "Knee, knee, shake, shake.", "Foot, foot, shake, shake.",
                "Tongue, tongue, shake, shake.", "Ear, ear, shake, shake.",
                "Hip, hip, shake, shake.", "Elbow, elbow, shake, shake."
            ]
        },
        {
            title: "Lesson Five: What Color Am I?",
            sentences: [
                "The sun is yellow.", "The sky is blue.", "The grass is green.",
                "The apple is red.", "The flower is purple.",
                "The leaves are green.", "The tree trunk is brown."
            ]
        },
        {
            title: "Lesson Six: Count with Me!",
            sentences: [
                "One, one! Show your thumb.", "Two, two! Touch your shoe.",
                "Three, three! Pat your knee.", "Four, four! Shut the door.",
                "Five, five! You can drive.", "Six, six! Letâ€™s mix.",
                "Seven, seven! Look at heaven.", "Eight, eight! Stand up straight.",
                "Nine, nine! Take a dive.", "Ten, ten! You can bend."
            ]
        },
        {
            title: "Lesson Seven: How Many",
            sentences: [
                "How many eyes do you have? I have two eyes.",
                "How many noses do you have? I have one nose.",
                "How many ears do you have? I have two ears.",
                "How many mouths do you have? I have one mouth."
            ]
        },
        {
            title: "Lesson Eight: I Want to Be Like You!",
            sentences: [
                "May I use your tie? So I can go to work.",
                "May I use your hammer? So I can build a house.",
                "May I use your rod? So I can go fishing?",
                "May I use your car? So I can drive.",
                "May I use your shoes? I want to be like you."
            ]
        },
        {
            title: "Lesson Nine: I Want to Be an Alien",
            sentences: [
                "I like to go swimming.", "I like to go shopping.",
                "I like to go to the hospital.", "I like to go to the zoo.",
                "I like to go to the playground.", "I like to go to the movies.",
                "I like to go to the beach.", "I like to go to the museum.",
                "I like to go to school."
            ]
        },
        {
            title: "Lesson Ten: Super Mom",
            sentences: [
                "She is smart. She can do math.", "She is strong. She can carry ten bags.",
                "She is fat. She can run.", "She sees everything.",
                "She can find my socks.", "She can fix anything.",
                "She can sew my shirt."
            ]
        }
    ];

    // è®Šæ•¸è¨­å®š
    let currentLessonIndex = 0;
    let currentSentenceIndex = 0;
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;
    let playbackAudio = new Audio();
    let isRecording = false;
    let synth = window.speechSynthesis;
    let voices = [];

    // DOM å…ƒç´ ç²å–
    const lessonSelect = document.getElementById('lessonSelect');
    const lessonTitle = document.getElementById('lessonTitle');
    const currentSentenceDiv = document.getElementById('currentSentence');
    const speakBtn = document.getElementById('speakBtn');
    const recordBtn = document.getElementById('recordBtn');
    const playbackBtn = document.getElementById('playbackBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const statusDiv = document.getElementById('status');
    const counterDiv = document.getElementById('counter');
    const recLabel = document.getElementById('recLabel');

    // --- åˆå§‹åŒ–åŠŸèƒ½ ---
    function init() {
        // å¡«å…¥èª²ç¨‹ä¸‹æ‹‰é¸å–®
        lessonData.forEach((lesson, index) => {
            let option = document.createElement('option');
            option.value = index;
            option.text = lesson.title;
            lessonSelect.appendChild(option);
        });

        // è¼‰å…¥èªéŸ³åŒ… (è§£æ±ºæŸäº›ç€è¦½å™¨éåŒæ­¥è¼‰å…¥å•é¡Œ)
        populateVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoices;
        }

        loadLesson(0);
        setupEventListeners();
    }

    // ç¢ºä¿è¼‰å…¥è‹±æ–‡èªéŸ³
    function populateVoices() {
        voices = synth.getVoices().filter(voice => voice.lang.includes('en'));
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè¼‰å…¥èª²ç¨‹èˆ‡å¥å­ ---
    function loadLesson(index) {
        currentLessonIndex = index;
        currentSentenceIndex = 0;
        lessonTitle.innerText = lessonData[currentLessonIndex].title;
        updateSentenceDisplay();
    }

    function updateSentenceDisplay() {
        const sentences = lessonData[currentLessonIndex].sentences;
        currentSentenceDiv.innerText = sentences[currentSentenceIndex];
        counterDiv.innerText = `${currentSentenceIndex + 1} / ${sentences.length}`;
        
        // é‡ç½®éŒ„éŸ³ç‹€æ…‹
        resetRecordingUI();
        statusDiv.innerText = "";
    }

    function resetRecordingUI() {
        playbackBtn.classList.add('disabled');
        audioBlob = null;
        if (isRecording) {
            stopRecording();
        }
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ–‡å­—è½‰èªéŸ³ (è€å¸«å”¸) ---
    function speakSentence() {
        if (synth.speaking) {
            synth.cancel();
        }
        const text = lessonData[currentLessonIndex].sentences[currentSentenceIndex];
        const utterThis = new SpeechSynthesisUtterance(text);
        
        // å˜—è©¦é¸æ“‡ä¸€å€‹è¼ƒå¥½çš„è‹±æ–‡è²éŸ³
        if (voices.length > 0) {
             // å„ªå…ˆå°‹æ‰¾ Google æˆ– Microsoft çš„é«˜å“è³ªå¥³è²
             let preferredVoice = voices.find(v => (v.name.includes('Google') || v.name.includes('Samantha')) && v.lang === 'en-US');
             if (preferredVoice) {
                 utterThis.voice = preferredVoice;
             } else {
                 utterThis.voice = voices[0]; // å¦å‰‡ä½¿ç”¨ç¬¬ä¸€å€‹å¯ç”¨çš„è‹±æ–‡
             }
        }
        
        utterThis.rate = 0.9; // ç¨å¾®æ”¾æ…¢é€Ÿåº¦æ›´é©åˆå­¸ç¿’
        synth.speak(utterThis);
        statusDiv.innerText = "æ­£åœ¨æ’­æ”¾ç¤ºç¯„...";
        utterThis.onend = () => { statusDiv.innerText = ""; };
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šéŒ„éŸ³ (å­¸ç”Ÿè®€) ---
    // è™•ç†è·¨å¹³å°éŒ„éŸ³çš„è¤‡é›œæ€§ (ç‰¹åˆ¥æ˜¯ iOS Safari)
    async function setupRecording() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³åŠŸèƒ½ã€‚è«‹ä½¿ç”¨ Chrome, Safari æˆ– Firefoxã€‚");
            return;
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´çš„éŒ„éŸ³æ ¼å¼
            let options = { mimeType: 'audio/webm' };
            if (!MediaRecorder.isTypeSupported('audio/webm')) {
                 // iOS Safari é€šå¸¸éœ€è¦ mp4
                 options = { mimeType: 'audio/mp4' };
                 if (!MediaRecorder.isTypeSupported('audio/mp4')) {
                     options = {}; // ä½¿ç”¨ç€è¦½å™¨é è¨­
                 }
            }

            mediaRecorder = new MediaRecorder(stream, options);

            mediaRecorder.ondataavailable = (e) => {
                audioChunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                // éŒ„éŸ³çµæŸï¼Œå»ºç«‹éŸ³é » Blob
                const mimeType = mediaRecorder.mimeType || 'audio/webm'; // ç²å–å¯¦éš›ä½¿ç”¨çš„æ ¼å¼
                audioBlob = new Blob(audioChunks, { type: mimeType });
                const audioUrl = URL.createObjectURL(audioBlob);
                playbackAudio.src = audioUrl;
                playbackBtn.classList.remove('disabled');
                statusDiv.innerText = "éŒ„éŸ³å®Œæˆï¼Œé»æ“Šæ’­æ”¾éµè½è½çœ‹ã€‚";
            };

        } catch (err) {
            console.error("ç„¡æ³•å­˜å–éº¥å…‹é¢¨:", err);
            alert("ç„¡æ³•å­˜å–éº¥å…‹é¢¨ã€‚è«‹ç¢ºä¿æ‚¨å·²æˆæ¬Šéº¥å…‹é¢¨æ¬Šé™ï¼Œä¸”ä½¿ç”¨ HTTPS é€£ç·šã€‚å¦‚æœåœ¨ iOS ä¸Šï¼Œè«‹ä½¿ç”¨ Safari é–‹å•Ÿã€‚");
        }
    }

    function toggleRecording() {
        if (!mediaRecorder) {
            alert("æ­£åœ¨åˆå§‹åŒ–éº¥å…‹é¢¨ï¼Œè«‹ç¨å¾Œå†è©¦...");
            setupRecording(); // å˜—è©¦é‡æ–°åˆå§‹åŒ–
            return;
        }

        if (isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    }

    function startRecording() {
        audioChunks = [];
        mediaRecorder.start();
        isRecording = true;
        recordBtn.classList.add('recording');
        recordBtn.innerText = "â¬›"; // åœæ­¢ç¬¦è™Ÿ
        recLabel.innerText = "åœæ­¢";
        statusDiv.innerText = "æ­£åœ¨éŒ„éŸ³...";
        playbackBtn.classList.add('disabled');
    }

    function stopRecording() {
        mediaRecorder.stop();
        isRecording = false;
        recordBtn.classList.remove('recording');
        recordBtn.innerText = "ğŸ¤";
        recLabel.innerText = "éŒ„éŸ³";
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ’­æ”¾éŒ„éŸ³ ---
    function playRecording() {
        if (audioBlob) {
            playbackAudio.play();
            statusDiv.innerText = "æ­£åœ¨æ’­æ”¾æ‚¨çš„éŒ„éŸ³...";
            playbackAudio.onended = () => { statusDiv.innerText = ""; };
        }
    }

    // --- äº‹ä»¶ç›£è½è¨­å®š ---
    function setupEventListeners() {
        lessonSelect.addEventListener('change', (e) => {
            loadLesson(e.target.value);
        });

        prevBtn.addEventListener('click', () => {
            if (currentSentenceIndex > 0) {
                currentSentenceIndex--;
                updateSentenceDisplay();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentSentenceIndex < lessonData[currentLessonIndex].sentences.length - 1) {
                currentSentenceIndex++;
                updateSentenceDisplay();
            }
        });

        speakBtn.addEventListener('click', speakSentence);
        
        // åœ¨ç¬¬ä¸€æ¬¡é»æ“Šæ™‚åˆå§‹åŒ–éŒ„éŸ³ï¼Œè§£æ±ºæŸäº›è¡Œå‹•è£ç½®çš„æ¬Šé™å•é¡Œ
        recordBtn.addEventListener('click', async () => {
            if (!mediaRecorder) {
                await setupRecording();
            }
            toggleRecording();
        });

        playbackBtn.addEventListener('click', playRecording);
    }

    // å•Ÿå‹•ç¨‹å¼
    init();
    // é å…ˆè«‹æ±‚éŒ„éŸ³æ¬Šé™ (é¸ç”¨ï¼Œæœ‰æ™‚èƒ½æ”¹å–„é«”é©—)
    // setupRecording(); 
</script>

</body>
</html>
